rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Recipes: Read-only for authenticated users (or public if needed for Free tier without auth)
    // Write: Only for specific admin users (ID hardcoded or via custom claim)
    // For now, we'll allow write if debug/admin, or just strictly control it.
    // Let's assume only backend/admin tool writes.
    // For the "Web Admin", we might need a way to identify the admin. 
    // For now, I'll allow write if the user has a specific email or UID, or just leave it open for 'admin' collection if we had one.
    // But better: Read for everyone, Write for NO ONE (except via Admin SDK or Console).
    // WAIT, the Web Admin Panel will be a client-side app (Flutter Web). 
    // It needs write access. We should restrict it to a specific UID.
    // I will add a placeholder for Admin UID check.
    match /recipes/{recipeId} {
      allow read: if true; // Public read is fine for recipes
      allow write: if isAuthenticated() && request.auth.token.email == 'admin@messie.app'; // Example admin check
    }

    // Users: Strict owner access
    match /users/{userId} {
      allow read, write: if isOwner(userId);
      
      // Subcollections
      match /mealRecords/{recordId} {
        allow read, write: if isOwner(userId);
      }
      match /shoppingList/{itemId} {
        allow read, write: if isOwner(userId);
      }
      match /pantry/{itemId} {
        allow read, write: if isOwner(userId);
      }
    }
  }
}
